<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RE Species Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #container {
      display: flex;
      height: 100%;
    }

    #map {
      flex: 2;
    }

    #sidebar {
      flex: 1;
      padding: 16px;
      box-sizing: border-box;
      overflow-y: auto;
      border-left: 1px solid #ddd;
      background: #f9f9f9;
    }

    h2 {
      margin-top: 0;
    }

    .species-list {
      padding-left: 1em;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="map"></div>
  <div id="sidebar">
    <h2>RE Species Viewer</h2>
    <p>This map shows Regional Ecosystem polygons, coloured by code. Click on an area to view a list of recorded species at that location.</p>
    <hr />
    <div id="info">
      <em>Click on the map to see species...</em>
    </div>
  </div>
</div>

<script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
      sources: {
        osm: {
          type: "raster",
          tiles: ["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "Â© OpenStreetMap contributors"
        },
        species: {
          type: "vector",
          tiles: ["https://foryourplant.github.io/re-seq-species-map/tiles/{z}/{x}/{y}.pbf"],
          minzoom: 0,
          maxzoom: 14
        }
      },
      layers: [
        {
          id: "osm-base",
          type: "raster",
          source: "osm",
          minzoom: 0,
          maxzoom: 22
        }
      ]
    },
    center: [151.7, -26.97],
    zoom: 10
  });

  let marker;

  fetch('https://foryourplant.github.io/re-seq-species-map/re-colours.json')
    .then(res => res.json())
    .then(colorMap => {
      const matchColors = ["match", ["get", "re"]];
      for (const re in colorMap) matchColors.push(re, colorMap[re]);
      matchColors.push("#cccccc");

      map.addLayer({
        id: "species-fill",
        type: "fill",
        source: "species",
        "source-layer": "species_fields",
        paint: {
          "fill-color": matchColors,
          "fill-opacity": 0.3
        }
      });

      /*map.addLayer({
        id: "species-labels",
        type: "symbol",
        source: "species",
        "source-layer": "species_fields",
        layout: {
          "text-field": ["get", "re"],
          "text-size": 12
        },
        paint: {
          "text-color": "#000",
          "text-halo-color": "#fff",
          "text-halo-width": 1
        }
      });*/

      map.on('click', (e) => {
        const features = map.queryRenderedFeatures(e.point, {
          layers: ['species-fill']
        });

        if (!features.length) return;

        const feature = features[0];
        const coords = e.lngLat;
        const props = feature.properties;

        // Drop marker
        if (marker) marker.remove();
        marker = new maplibregl.Marker().setLngLat(coords).addTo(map);

        // Build species list
        let species = Object.keys(props)
          .filter(k => k.startsWith("species_"))
          .map(k => props[k])
          .filter(v => v && v.trim() !== "");

        const reCodes = props.re.split("/").map(code => code.trim());
        const reLinks = reCodes.map(code => `<a href="https://apps.des.qld.gov.au/regional-ecosystems/details/?re=${encodeURIComponent(code)}" target="_blank">${code}</a>`).join(" / ");

        const infoDiv = document.getElementById('info');
        infoDiv.innerHTML = `
          <h3>RE ${reLinks}</h3>
          <!--<p><strong>Polygon ID:</strong> ${props.polygon_id}</p>-->
          <h4>Species List (${species.length})</h4>
          ${
            species.length > 0
              ? `<ul class="species-list">
                  ${species.map(s => `<li><a href="https://bie.ala.org.au/species/${encodeURIComponent(s)}" target="_blank">${s}</a></li>`).join('')}
                </ul>`
              : `<p>This RE has no available species surveyed.</p>`
          }
        `;

      });

      map.addControl(new maplibregl.NavigationControl());
    });
</script>
</body>
</html>
