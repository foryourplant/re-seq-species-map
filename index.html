<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RE Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <style>html, body, #map { margin: 0; height: 100%; }</style>
</head>
<body>
  <div id="map"></div>
  <script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        "openmaptiles": {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256
        },
        "species": {
          type: "vector",
          tiles: ["https://foryourplant.github.io/re-seq-species-map/tiles/{z}/{x}/{y}.pbf"],
          minzoom: 0,
          maxzoom: 14
        }
      },
      layers: [
        {
          id: "osm-basemap",
          type: "raster",
          source: "openmaptiles"
        }
      ]
    },
    center: [153.0, -27.5],
    zoom: 6
  });

  map.on('load', () => {
    fetch('re-colors.json')
      .then(res => res.json())
      .then(colorMap => {
        const match = ['match', ['get', 'RE']];
        for (const [re, color] of Object.entries(colorMap)) {
          match.push(re, color);
        }
        match.push('#cccccc'); // fallback color

        map.addLayer({
          id: 'species-fill',
          type: 'fill',
          source: 'species',
          'source-layer': 'species_fields',
          paint: {
            'fill-color': match,
            'fill-opacity': 0.6
          }
        });
      });
  });

  map.on('click', 'species-fill', function (e) {
    const props = e.features[0].properties;
    let html = "";
    for (const key in props) {
      html += `<strong>${key}</strong>: ${props[key]}<br/>`;
    }
    new maplibregl.Popup()
      .setLngLat(e.lngLat)
      .setHTML(html)
      .addTo(map);
  });
</script>

</body>
</html>
