<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RE Species Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
    }

    #container {
      display: flex;
      flex-direction: row;
      height: 100%;
    }

    #map {
      flex: 2;
      min-height: 300px;
    }

    #sidebar {
      flex: 1;
      padding: 16px;
      box-sizing: border-box;
      overflow-y: auto;
      border-left: 1px solid #ddd;
      background: #fafafa;
    }

    h2, h3, h4 {
      margin-top: 0;
    }

    .species-list {
      padding-left: 1.25em;
    }

    .zoom-btn {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      z-index: 10;
    }

    .zoom-btn:hover {
      background: #f0f0f0;
    }

    @media (max-width: 768px) {
      #container {
        flex-direction: column;
      }

      #map {
        height: 50vh;
      }

      #sidebar {
        border-left: none;
        border-top: 1px solid #ddd;
      }

      .zoom-btn {
        bottom: 10px;
        left: 10px;
      }
    }
  </style>
</head>
<body>
<div id="container">
  <div id="map"></div>
  <div id="sidebar">
    <h2>RE Species Viewer</h2>
    <p>This interactive map displays Queensland's Regional Ecosystems, coloured by their RE code. Click any polygon to view associated plant species.</p>
    <hr />
    <div id="info">
      <em>Click on the map to see species...</em>
    </div>
  </div>
</div>

<button class="zoom-btn" onclick="zoomToUser()">üìç My Location</button>

<script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
      sources: {
        osm: {
          type: "raster",
          tiles: ["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "¬© OpenStreetMap contributors"
        },
        species: {
          type: "vector",
          tiles: ["https://foryourplant.github.io/re-seq-species-map/tiles/{z}/{x}/{y}.pbf"],
          minzoom: 0,
          maxzoom: 14
        }
      },
      layers: [
        {
          id: "osm-base",
          type: "raster",
          source: "osm",
          minzoom: 0,
          maxzoom: 22
        }
      ]
    },
    center: [152.66, -27.38],
    zoom: 10
  });

  let marker;

  fetch('https://foryourplant.github.io/re-seq-species-map/re-colours.json')
    .then(res => res.json())
    .then(colorMap => {
      const matchColors = ["match", ["get", "re"]];
      for (const re in colorMap) matchColors.push(re, colorMap[re]);
      matchColors.push("#cccccc");

      map.addLayer({
        id: "species-fill",
        type: "fill",
        source: "species",
        "source-layer": "species_fields",
        paint: {
          "fill-color": matchColors,
          "fill-opacity": 0.25
        }
      });

      map.on('click', (e) => {
        const features = map.queryRenderedFeatures(e.point, {
          layers: ['species-fill']
        });

        if (!features.length) return;

        const feature = features[0];
        const coords = e.lngLat;
        const props = feature.properties;

        // Drop marker
        if (marker) marker.remove();
        marker = new maplibregl.Marker().setLngLat(coords).addTo(map);

        // Build species list
        let species = Object.keys(props)
          .filter(k => k.startsWith("species_"))
          .map(k => props[k])
          .filter(v => v && v.trim() !== "");

        const reCodes = props.re.split("/").map(code => code.trim());
        const reLinks = reCodes.map(code =>
          `<a href="https://apps.des.qld.gov.au/regional-ecosystems/details/?re=${encodeURIComponent(code)}" target="_blank">${code}</a>`
        ).join(" / ");

        const infoDiv = document.getElementById('info');
        infoDiv.innerHTML = `
          <h3>RE ${reLinks}</h3>
          <h4>Species List (${species.length})</h4>
          ${
            species.length > 0
              ? `<ul class="species-list">
                  ${species.map(s => `<li><a href="https://bie.ala.org.au/species/${encodeURIComponent(s)}" target="_blank">${s}</a></li>`).join('')}
                </ul>`
              : `<p><em>This RE has no available species surveyed.</em></p>`
          }
        `;
      });

      map.addControl(new maplibregl.NavigationControl());
    });

  function zoomToUser() {
    if (!navigator.geolocation) {
      alert("Geolocation not supported in your browser.");
      return;
    }

    navigator.geolocation.getCurrentPosition(position => {
      const { latitude, longitude } = position.coords;
      map.flyTo({ center: [longitude, latitude], zoom: 14 });
    }, () => {
      alert("Unable to access your location.");
    });
  }
</script>
</body>
</html>
