<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RE Species Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
      sources: {
        // Basemap source (OpenStreetMap raster)
        "osm": {
          type: "raster",
          tiles: [
            "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"
          ],
          tileSize: 256,
          attribution: "Â© OpenStreetMap contributors"
        },
        // Vector tile source
        "species": {
          type: "vector",
          tiles: ["https://foryourplant.github.io/re-seq-species-map/tiles/{z}/{x}/{y}.pbf"],
          minzoom: 0,
          maxzoom: 14
        }
      },
      layers: [
        // Basemap layer
        {
          id: "osm-base",
          type: "raster",
          source: "osm",
          minzoom: 0,
          maxzoom: 22
        }
        // The species layers will be added after loading the JSON
      ]
    },
    center: [151.7, -26.97],
    zoom: 10
  });

  // Load colour mapping and inject vector style layers
  fetch('https://foryourplant.github.io/re-seq-species-map/re-colours.json')
    .then(response => response.json())
    .then(colorMap => {
      const matchColors = ["match", ["get", "re"]];
      for (const re in colorMap) {
        matchColors.push(re, colorMap[re]);
      }
      matchColors.push("#cccccc"); // fallback

      // Fill polygons with RE-based colours
      map.addLayer({
        id: "species-fill",
        type: "fill",
        source: "species",
        "source-layer": "species_fields", // double-check your actual source-layer name
        paint: {
          "fill-color": matchColors,
          "fill-opacity": 0.6
        }
      });

      // Add labels with RE name
      map.addLayer({
        id: "species-labels",
        type: "symbol",
        source: "species",
        "source-layer": "species_fields",
        layout: {
          "text-field": ["get", "re"],
          "text-size": 12
        },
        paint: {
          "text-color": "#000",
          "text-halo-color": "#fff",
          "text-halo-width": 1
        }
      });
    })
    .catch(err => console.error("Failed to load re-colours.json:", err));

  map.addControl(new maplibregl.NavigationControl());
</script>
</body>
</html>
